<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Tacti.OS ‚Äî Session Planner</title>
<style>
  :root{
    --ink:#111;--muted:#666;--line:#d9d9d9;--box:#f7f7f7;--green:#E0F3E4;
    --side-expanded:220px; --side-collapsed:56px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:#fff;color:var(--ink);font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}

  /* Top bar */
  .toolbar{position:sticky;top:0;z-index:40;display:flex;gap:10px;align-items:center;padding:10px 14px;border-bottom:1px solid var(--line);background:#fff}
  .toolbar h1{font-size:16px;margin:0}
  .sp{flex:1}
  button{appearance:none;background:#fff;border:1px solid var(--line);padding:7px 10px;border-radius:10px;cursor:pointer}
  button.primary{background:#111;color:#fff;border-color:#111}
  button.small{padding:6px 8px;border-radius:8px;font-size:12px}
  button.active{outline:2px solid #111}

  /* Docked expand/collapse toggle (LEFT) */
  .dock-toggle{
    position:fixed;
    left:8px; top:58px;      /* sits just under top bar */
    z-index:50;
    padding:8px 10px;
    border:1px solid var(--line);
    border-radius:10px;
    background:#fff;
    cursor:pointer;
    font-size:0;
  }
  body.sidebar-collapsed .dock-toggle::after{ content:"‚ü©‚ü©"; }
  body:not(.sidebar-collapsed) .dock-toggle::after{ content:"‚ü®‚ü®"; }
  .dock-toggle::after{ font-size:14px; color:var(--ink); }

  /* Layout: left sidebar + content (desktop) */
  .wrap{display:grid;grid-template-columns:var(--side-expanded) 1fr;gap:0;max-width:1200px;margin:0 auto}
  @media(max-width:900px){ .wrap{grid-template-columns:1fr} }

  /* Sidebar (desktop expanded) */
  .side{
    position:sticky; top:52px; align-self:start;
    height:calc(100vh - 52px);
    overflow:auto;             /* desktop: vertical scroll if needed */
    border-right:1px solid var(--line);
    padding:12px;
    background:#fff; z-index:30;
    width:var(--side-expanded);
    transition:width .25s ease, padding .25s ease;
  }

  .sec{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
  .chip{padding:4px 8px;border:1px solid var(--line);background:var(--box);border-radius:8px;font-size:12px;font-weight:600;color:#555;cursor:default;user-select:none}
  .toolrow{display:flex;flex-wrap:wrap;gap:6px}
  .btn{display:inline-flex;align-items:center;gap:8px}
  .ico{display:inline-flex;width:20px;height:20px;align-items:center;justify-content:center}
  .ico svg{width:20px;height:20px;stroke:#222;fill:none}
  .ico.fill svg{fill:#222;stroke:none}
  .bin{margin-top:6px;border:1px dashed #bbb;border-radius:10px;padding:10px;text-align:center;color:#555;transition:background .15s,border-color .15s}
  .bin.active{border-color:#111;background:#fafafa}
  .side .status{font-size:12px;color:#555;margin-top:6px}

  /* Collapsed (thin rail): content stays full width */
  body.sidebar-collapsed .wrap{ grid-template-columns:1fr; } /* no shrink */
  body.sidebar-collapsed .side{
    position:fixed; left:8px; top:52px;
    height:calc(100vh - 52px);
    width:var(--side-collapsed);
    padding:12px 6px;
    border-right:1px solid var(--line);
    z-index:35;
    overflow:auto;           /* scrollable rail if tall */
  }
  body.sidebar-collapsed .chip{display:none}
  body.sidebar-collapsed .toolrow{gap:8px}
  body.sidebar-collapsed .btn{justify-content:center}
  body.sidebar-collapsed .btn .label{display:none}
  /* Collapsed rail: trash bin = icon only */
  body.sidebar-collapsed .bin{
    width:42px; height:42px;
    padding:0;
    display:flex; align-items:center; justify-content:center;
    border:1px dashed #bbb;
    border-radius:10px;
    background:#fff;
    text-indent:-9999px;       /* hide text */
    overflow:hidden;
    position:relative;
  }
  body.sidebar-collapsed .bin::before{
    content:"üóëÔ∏è";
    text-indent:0;
    position:absolute; inset:0;
    display:flex; align-items:center; justify-content:center;
    font-size:18px;
  }
  body.sidebar-collapsed .bin.active{ border-color:#111; background:#fafafa; }
  /* Hide Numbers section entirely when collapsed */
  body.sidebar-collapsed .sec-numbers{ display:none; }

  /* Content area */
  .page{padding:16px;display:grid;gap:14px}
  .card{border:1px solid var(--line);border-radius:16px;padding:12px}
  .title{font-weight:600;color:#444;margin:0 0 8px 0;font-size:18px}
  .mini-lab{font-weight:600;color:#555;font-size:14px;margin:8px 0 4px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .row-30-70{grid-template-columns:30% 70%}
  input[type=text]{width:100%;border:1px solid var(--line);border-radius:8px;padding:8px 10px;background:#fff}
  textarea{width:100%;border:1px solid var(--line);border-radius:10px;padding:10px;background:#fff;min-height:96px}

  /* Summary */
  .summary{border:1px solid var(--line);border-radius:10px;overflow:hidden;background:var(--box)}
  .summary .hdr, .summary .r{display:grid;grid-template-columns:20% 20% 60%}
  .summary .hdr{font-size:12px;font-weight:600;color:#666;border-bottom:1px solid var(--line)}
  .summary .hdr>div, .summary .r>div{padding:6px 8px;border-left:1px solid var(--line)}
  .summary .hdr>div:first-child, .summary .r>div:first-child{border-left:0}

  /* Drills */
  .drill{border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:5mm}
  .drill .hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
  .two-col{display:grid;grid-template-columns:62% 38%;gap:16px} /* wider editor column */

  /* Pitch + drawing */
  .pitch{position:relative;background:var(--green);border:1px solid #aaa;border-radius:12px;aspect-ratio:13/10;width:100%;overflow:hidden;outline-offset:3px}
  .pitch svg{width:100%;height:100%;display:block}
  .draw-layer,.grid-layer{position:absolute;inset:0}
  .grid-layer{pointer-events:none}
  .active-pitch{outline:3px solid #111}
  .selbox{position:absolute;border:1px dashed #111;background:rgba(17,17,17,.04);pointer-events:none}

  .notes{border:1px solid var(--line);border-radius:10px;height:120px}
  .footer{color:#999;font-size:11px;text-align:right;margin-top:6px}

  /* Mobile layout: toolbar docks at bottom when expanded */
  @media (max-width:900px){
    .wrap{grid-template-columns:1fr}
    .side{
      position:fixed; bottom:0; left:0; right:0; top:auto;
      max-height:45vh;           /* scroll up/down */
      overflow-y:auto; overflow-x:hidden;
      border-right:none; border-top:1px solid var(--line);
      width:auto;
    }
    .page{padding-bottom:110px}  /* keep content above toolbar */
    button.small{padding:10px 12px}
    /* Collapsed on mobile: transform into a thin bottom rail */
    body.sidebar-collapsed .side{
      height:64px; max-height:64px;
      overflow-x:auto; overflow-y:hidden;
      display:flex; align-items:center; gap:10px;
      padding:8px 8px;
    }
    /* Docked toggle repositioned near bottom-left */
    .dock-toggle{
      left:8px; top:auto;
      bottom: calc(45vh + 8px);  /* above expanded toolbar */
    }
    body.sidebar-collapsed .dock-toggle{
      bottom:72px;               /* above collapsed rail */
    }
  }

  @media print{
    .toolbar,.side,.dock-toggle{display:none}
    .wrap{display:block}
    .page{padding:0}
    input,textarea{border:none !important}
    @page{size:A4 portrait;margin:10mm}
  }
</style>
</head>
<body>
  <!-- Top -->
  <div class="toolbar">
    <h1>Tacti.OS ‚Äî Session Planner</h1>
    <div class="sp"></div>
    <button id="btnPrint" class="primary">Print / Export PDF</button>
  </div>

  <!-- Docked expand/collapse toggle (left) -->
  <button id="btnToggleSidebarDock" class="dock-toggle" aria-label="Collapse tools"></button>

  <div class="wrap">
    <!-- LEFT: Global toolbar -->
    <aside class="side" id="sidebar">
      <div class="sec">
        <div class="chip">Tools</div>
        <div class="toolrow">
          <button class="small btn" data-tool="select">
            <span class="ico">
              <!-- Minimalist Select -->
              <svg viewBox="0 0 24 24"><rect x="5" y="5" width="10" height="10" stroke-width="1.75" stroke="#222" stroke-dasharray="3 3"/><path d="M16 16l3 3" stroke="#222" stroke-width="1.75" stroke-linecap="round"/></svg>
            </span><span class="label">Select</span>
          </button>
          <button class="small btn" data-tool="pen">
            <span class="ico"><svg viewBox="0 0 24 24"><path d="M4 20l4-1l9-9l-3-3l-9 9l-1 4z" stroke="#222" stroke-width="1.75" fill="none"/><circle cx="14" cy="10" r="1.25" fill="#222"/></svg></span><span class="label">Pen</span>
          </button>
          <button class="small btn" data-tool="eraser">
            <span class="ico"><svg viewBox="0 0 24 24"><path d="M4 15l6-6h4l6 6-6 5H8z" stroke="#222" stroke-width="1.75" fill="none" stroke-linejoin="round"/></svg></span><span class="label">Eraser</span>
          </button>
          <button class="small btn" data-tool="arrow">
            <span class="ico"><svg viewBox="0 0 24 24"><path d="M4 12h12" stroke="#222" stroke-width="1.75" stroke-linecap="round"/><path d="M13 7l6 5-6 5" stroke="#222" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round"/></svg></span><span class="label">Arrow</span>
          </button>
        </div>
      </div>

      <div class="sec">
        <div class="chip">Stamps</div>
        <div class="toolrow">
          <button class="small btn" data-tool="playerA">
            <span class="ico fill"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="8"/><text x="12" y="13" text-anchor="middle" font-size="10" font-family="system-ui" fill="#fff">A</text></svg></span><span class="label">Player A</span>
          </button>
          <button class="small btn" data-tool="playerB">
            <span class="ico fill"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="8"/><text x="12" y="13" text-anchor="middle" font-size="10" font-family="system-ui" fill="#fff">B</text></svg></span><span class="label">Player B</span>
          </button>
          <button class="small btn" data-tool="cone">
            <span class="ico fill"><svg viewBox="0 0 24 24"><path d="M12 6l-6 10h12z"/></svg></span><span class="label">Cone</span>
          </button>
          <button class="small btn" data-tool="ball">
            <span class="ico"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="8" fill="#fff" stroke="#222" stroke-width="1.75"/><path d="M12 4v16M4 12h16" stroke="#222" stroke-width="1.25" opacity=".45"/></svg></span><span class="label">Ball</span>
          </button>
        </div>
      </div>

      <div class="sec sec-numbers">
        <div class="chip">Numbers</div>
        <div class="toolrow" style="gap:8px">
          <label class="small" style="display:flex;align-items:center;gap:6px;color:#555"><input type="checkbox" id="toggleNumbers"> Show #</label>
          <label class="small" style="display:flex;align-items:center;gap:6px;color:#555">Next # <input type="number" id="nextNumber" value="1" min="0" style="width:68px"></label>
          <label class="small" style="display:flex;align-items:center;gap:6px;color:#555">Set # <input type="number" id="setNumber" value="0" min="0" style="width:68px"> <button class="small" id="applyNumber">Apply</button></label>
        </div>
      </div>

      <div class="sec">
        <div class="chip">Actions</div>
        <div class="toolrow">
          <button class="small btn" data-act="undo"><span class="ico"><svg viewBox="0 0 24 24"><path d="M8 8H4v4" stroke="#222" stroke-width="1.75" stroke-linecap="round"/><path d="M4 12c2.5-4.5 9-6 13-2c2 2 3 5 3 7" stroke="#222" stroke-width="1.75"/></svg></span><span class="label">Undo</span></button>
          <button class="small btn" data-act="redo"><span class="ico"><svg viewBox="0 0 24 24"><path d="M16 8h4v4" stroke="#222" stroke-width="1.75" stroke-linecap="round"/><path d="M20 12c-2.5-4.5 9-6 13-2c-2 2-3 5-3 7" stroke="#222" stroke-width="1.75"/></svg></span><span class="label">Redo</span></button>
          <button class="small btn" data-act="clear"><span class="ico"><svg viewBox="0 0 24 24"><path d="M4 7h16" stroke="#222" stroke-width="1.75"/><path d="M7 7l1 12h8l1-12" stroke="#222" stroke-width="1.75"/><path d="M9 7l1-2h4l1 2" stroke="#222" stroke-width="1.75"/></svg></span><span class="label">Clear</span></button>
          <button class="small btn" data-act="grid"><span class="ico"><svg viewBox="0 0 24 24"><rect x="4" y="4" width="16" height="16" stroke="#222" stroke-width="1.75"/><path d="M12 4v16M4 12h16" stroke="#222" stroke-width="1.25"/></svg></span><span class="label">Grid</span></button>
          <button class="small btn" data-act="sizePlus"><span class="ico"><svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14" stroke="#222" stroke-width="1.75" stroke-linecap="round"/></svg></span><span class="label">Size +</span></button>
          <button class="small btn" data-act="sizeMinus"><span class="ico"><svg viewBox="0 0 24 24"><path d="M5 12h14" stroke="#222" stroke-width="1.75" stroke-linecap="round"/></svg></span><span class="label">Size ‚àí</span></button>
          <button class="small btn" data-act="deleteSelected"><span class="ico"><svg viewBox="0 0 24 24"><path d="M6 6l12 12M18 6L6 18" stroke="#222" stroke-width="1.75" stroke-linecap="round"/></svg></span><span class="label">Delete Selected</span></button>
        </div>
        <div class="bin" id="trashBin" aria-label="Trash bin ‚Äî drag here to delete">Drag here to delete</div>
        <div class="status" id="activeChip">Editing: Drill 1</div>
      </div>

      <div class="sec">
        <div class="chip">Drills</div>
        <div class="toolrow">
          <button class="small btn" id="btnAddDrill">
            <span class="ico"><svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14" stroke="#222" stroke-width="1.75" stroke-linecap="round"/></svg></span>
            <span class="label">Add Drill</span>
          </button>
          <button class="small btn" id="btnRemoveDrill">
            <span class="ico"><svg viewBox="0 0 24 24"><path d="M5 12h14" stroke="#222" stroke-width="1.75" stroke-linecap="round"/></svg></span>
            <span class="label">Remove Last</span>
          </button>
        </div>
      </div>
    </aside>

    <!-- RIGHT: Content -->
    <main class="page" id="app">
      <!-- Header -->
      <div class="card">
        <div class="title">Session Header</div>
        <div class="row">
          <label><span class="mini-lab">Session Title</span><input type="text" id="title"></label>
          <label><span class="mini-lab">Age Group</span><input type="text" id="ageGroup"></label>
        </div>
        <div class="row row-30-70" style="margin-top:8px">
          <label><span class="mini-lab">Players</span><input type="text" id="players"></label>
          <label><span class="mini-lab">Objective</span><input type="text" id="objective"></label>
          <label><span class="mini-lab">Area needed</span><input type="text" id="area"></label>
          <label><span class="mini-lab">Equipment</span><input type="text" id="equipment"></label>
        </div>
      </div>

      <!-- Overview -->
      <div class="card">
        <div class="title">Drill Overview (editable)</div>
        <div class="summary" id="overview">
          <div class="hdr"><div>Drill</div><div>Duration</div><div>Purpose / Notes</div></div>
          <!-- rows injected -->
        </div>
      </div>

      <!-- Drills -->
      <div id="drills"></div>

      <!-- Notes -->
      <div class="card">
        <div class="title">Coach Notes / Reflection</div>
        <div class="notes"></div>
        <div class="footer">Template by Alex Hammond-Cole | Tacti.OS</div>
      </div>
    </main>
  </div>

<script>
(function(){
  const $ = (s,root=document)=>root.querySelector(s);
  const $$ = (s,root=document)=>Array.from(root.querySelectorAll(s));

  // ---- Data ----
  const defaultDrills = [
    { name:"Passing Practice",   duration:"~10 min",    purpose:"Warm up & intro of session focus", setup:"", exercise:"", progression:"" },
    { name:"Positioning Game",   duration:"~10‚Äì15 min", purpose:"Posession Game",                    setup:"", exercise:"", progression:"" },
    { name:"Game Training",      duration:"~20‚Äì25 min", purpose:"Realistic match situation",         setup:"", exercise:"", progression:"" },
    { name:"Training Game",      duration:"~20‚Äì25 min", purpose:"Game",                               setup:"", exercise:"", progression:"" }
  ];

  const state = {
    title:"", ageGroup:"", players:"", objective:"", area:"", equipment:"",
    drills: JSON.parse(JSON.stringify(defaultDrills)),
    drawings: [],      // per-drill {actions:[], redo:[], grid:false, selection:number[]}
    active: 0,
    tool: 'select',
    showNumbers: false,
    nextNumber: 1
  };
  state.drawings = state.drills.map(()=>({actions:[],redo:[],grid:false, selection:[]}));

  // ---- Collapsible sidebar (dock toggle) ----
  const TOGGLE_KEY='tactios-sidebar-collapsed';
  const btnDock = $("#btnToggleSidebarDock");
  function applySidebarCollapsed(collapsed){
    document.body.classList.toggle('sidebar-collapsed', collapsed);
    // re-measure canvases since layout changed
    state.drills.forEach((_,i)=>renderCanvas(i));
  }
  const savedCollapsed = localStorage.getItem(TOGGLE_KEY)==='1';
  applySidebarCollapsed(savedCollapsed);
  btnDock.addEventListener('click', ()=>{
    const next = !document.body.classList.contains('sidebar-collapsed');
    localStorage.setItem(TOGGLE_KEY, next?'1':'0');
    applySidebarCollapsed(next);
  });

  // ---- Header + overview ----
  ["title","ageGroup","players","objective","area","equipment"].forEach(id=>{
    $("#"+id).addEventListener("input", e=>{ state[id]=e.target.value; });
  });

  const overview = $("#overview");
  function renderOverview(){
    $$(".r", overview).forEach(n=>n.remove());
    state.drills.forEach((d,i)=>{
      const row = document.createElement("div");
      row.className = "r";
      row.innerHTML = `
        <div><input type="text" value="${esc(d.name)}" data-i="${i}" data-k="name" style="width:100%"></div>
        <div><input type="text" value="${esc(d.duration)}" data-i="${i}" data-k="duration" style="width:100%"></div>
        <div><input type="text" value="${esc(d.purpose)}" data-i="${i}" data-k="purpose" style="width:100%"></div>
      `;
      overview.appendChild(row);
    });
    $$("input", overview).forEach(inp=>{
      inp.addEventListener("input", e=>{
        const i=+e.target.dataset.i, k=e.target.dataset.k;
        state.drills[i][k]=e.target.value;
        const hdr = $(`.drill[data-i="${i}"] .name`);
        if(hdr && k==="name") hdr.textContent = e.target.value || `Drill ${i+1}`;
      });
    });
  }

  // ---- Sidebar tools ----
  const sidebar = $("#sidebar"), bin = $("#trashBin");
  function setActiveTool(tool){
    state.tool = tool;
    $$("button[data-tool]", sidebar).forEach(b=>b.classList.toggle("active", b.dataset.tool===tool));
  }
  setActiveTool('select');

  $("#toggleNumbers").addEventListener("change", e=>{
    state.showNumbers = e.target.checked;
    state.drills.forEach((_,i)=>renderCanvas(i));
  });
  $("#nextNumber").addEventListener("input", e=>{ state.nextNumber = +e.target.value || 0; });
  $("#applyNumber").addEventListener("click", ()=>{
    const n = +$("#setNumber").value || 0;
    const D = state.drawings[state.active];
    D.selection.forEach(idx=>{
      const a = D.actions[idx];
      if(a && a.type==='stamp' && (a.kind==='playerA' || a.kind==='playerB')) a.num = n;
    });
    renderCanvas(state.active);
  });

  sidebar.addEventListener("click", e=>{
    const btn = e.target.closest("button");
    if(!btn) return;
    const tool = btn.dataset.tool;
    const act  = btn.dataset.act;
    if(tool){ setActiveTool(tool); return; }

    const D = state.drawings[state.active];
    if(act==="undo"){
      if(D.actions.length){ D.redo.push(D.actions.pop()); D.selection=[]; renderCanvas(state.active); }
    } else if(act==="redo"){
      if(D.redo.length){ D.actions.push(D.redo.pop()); D.selection=[]; renderCanvas(state.active); }
    } else if(act==="clear"){
      D.actions = []; D.redo = []; D.selection=[]; renderCanvas(state.active);
    } else if(act==="grid"){
      D.grid = !D.grid; renderCanvas(state.active);
    } else if(act==="sizePlus"){
      scaleSelection(1.15);
    } else if(act==="sizeMinus"){
      scaleSelection(1/1.15);
    } else if(act==="deleteSelected"){
      deleteSelection();
    }
  });

  // drill add/remove (global)
  $("#btnAddDrill").addEventListener("click", ()=>{
    state.drills.push({name:"New Drill", duration:"", purpose:"", setup:"", exercise:"", progression:""});
    state.drawings.push({actions:[], redo:[], grid:false, selection:[]});
    state.active = state.drills.length - 1;
    renderAll();
    scrollToDrill(state.active);
  });

  $("#btnRemoveDrill").addEventListener("click", ()=>{
    if(!state.drills.length) return;
    const idx = state.active;
    state.drills.splice(idx,1);
    state.drawings.splice(idx,1);
    state.active = Math.max(0, idx-1);
    renderAll();
  });

  // ---- Drills list ----
  const drillsRoot = $("#drills");
  function renderDrills(){
    drillsRoot.innerHTML = "";
    state.drills.forEach((d,i)=>{
      const card = document.createElement("div");
      card.className = "card drill";
      card.dataset.i = i;
      card.innerHTML = `
        <div class="hdr">
          <div class="name">${esc(d.name) || `Drill ${i+1}`}</div>
          <button class="small" title="Delete drill" data-act="trash" data-i="${i}">üóëÔ∏è</button>
        </div>
        <div class="two-col">
          <div>
            <div class="mini-lab">Setup</div>
            <textarea data-i="${i}" data-k="setup">${esc(d.setup)}</textarea>
            <div class="mini-lab">Exercise</div>
            <textarea data-i="${i}" data-k="exercise">${esc(d.exercise)}</textarea>
            <div class="mini-lab">Progression</div>
            <textarea data-i="${i}" data-k="progression">${esc(d.progression)}</textarea>
          </div>
          <div>
            <div class="pitch" data-i="${i}" tabindex="0">
              <svg viewBox="0 0 1000 650" aria-hidden="true">
                <rect x="10" y="10" width="980" height="630" fill="none" stroke="#AAAAAA" stroke-width="3"/>
                <line x1="20" y1="40" x2="980" y2="40" stroke="#BBBBBB" stroke-width="2"/>
                <rect x="160" y="300" width="680" height="260" fill="none" stroke="#AAAAAA" stroke-width="2"/>
                <rect x="260" y="410" width="480" height="150" fill="none" stroke="#AAAAAA" stroke-width="2"/>
                <circle cx="500" cy="360" r="6" fill="#AAAAAA"/>
              </svg>
              <canvas class="draw-layer"></canvas>
              <canvas class="grid-layer"></canvas>
              <div class="selbox" hidden></div>
            </div>
          </div>
        </div>
      `;
      drillsRoot.appendChild(card);

      // per-drill trash
      card.querySelector('[data-act="trash"]').addEventListener("click", ()=>{
        const idx = i;
        state.drills.splice(idx,1);
        state.drawings.splice(idx,1);
        state.active = Math.max(0, Math.min(state.active, state.drills.length-1));
        renderAll();
      });

      // text bindings
      $$("textarea", card).forEach(t=>{
        t.addEventListener("input", e=>{
          const i2=+e.target.dataset.i, k=e.target.dataset.k;
          state.drills[i2][k]=e.target.value;
        });
      });

      // canvas setup
      const pitch = card.querySelector(".pitch");
      setupCanvas(pitch, i);
      if(i===state.active) pitch.classList.add("active-pitch");
      pitch.addEventListener("click", ()=>setActivePitch(i));
    });
    updateActiveChip();
  }

  function setActivePitch(i){
    state.active = i;
    $$(".pitch").forEach(p=>p.classList.remove("active-pitch"));
    const pitch = $(`.pitch[data-i="${i}"]`);
    if(pitch) pitch.classList.add("active-pitch");
    updateActiveChip();
  }
  function updateActiveChip(){
    $("#activeChip").textContent = `Editing: Drill ${state.active+1}`;
  }

  function scrollToDrill(i){
    const el = $(`.drill[data-i="${i}"]`);
    if(el) el.scrollIntoView({behavior:'smooth', block:'center'});
  }

  // ---- Canvas engine (marquee, drag, bin) ----
  function setupCanvas(pitch, i){
    const layer = pitch.querySelector(".draw-layer");
    const gridL = pitch.querySelector(".grid-layer");
    const selBox = pitch.querySelector(".selbox");
    function resize(){
      const r = pitch.getBoundingClientRect();
      [layer, gridL].forEach(c=>{ c.width=r.width; c.height=r.height; });
      renderCanvas(i);
    }
    new ResizeObserver(resize).observe(pitch);
    resize();

    let drawing=false, cur=null;
    let draggingSelection=false, dragStart=null;
    let marquee=false, mStart=null, mRect=null;

    function pos(e){
      const r=layer.getBoundingClientRect();
      const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left;
      const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top;
      return {x,y};
    }

    function hitStampAt(x,y, D){
      for(let k=D.actions.length-1;k>=0;k--){
        const a = D.actions[k];
        if(a.type==='stamp'){
          const rad = (a.sz||1)*10 + 4;
          const dx = x-a.x, dy=y-a.y;
          if(dx*dx+dy*dy <= rad*rad) return k;
        }
      }
      return -1;
    }

    function down(e){
      e.preventDefault();
      setActivePitch(i);
      const tool = state.tool;
      const D = state.drawings[i];
      const p = pos(e);

      if(tool==='select'){
        const hit = hitStampAt(p.x,p.y,D);
        if(hit>=0){
          if(e.shiftKey){
            const j = D.selection.indexOf(hit);
            if(j>=0) D.selection.splice(j,1);
            else D.selection.push(hit);
          } else {
            if(D.selection.length!==1 || D.selection[0]!==hit) D.selection = [hit];
          }
          draggingSelection = true; dragStart = p;
        } else {
          // start marquee
          D.selection = [];
          marquee = true; mStart = p; mRect = {x: p.x, y: p.y, w: 0, h: 0};
          drawSelBox(selBox, mRect);
        }
        renderCanvas(i);
        return;
      }

      D.redo = [];
      if(tool==='pen'){
        drawing=true; cur={type:'path', color:'#111', w:3, pts:[p]}; D.actions.push(cur);
      } else if(tool==='eraser'){
        drawing=true; cur={type:'path', color:'#fff', w:16, pts:[p]}; D.actions.push(cur);
      } else if(tool==='arrow'){
        drawing=true; cur={type:'arrow', color:'#111', w:3, x1:p.x, y1:p.y, x2:p.x, y2:p.y}; D.actions.push(cur);
      } else { // stamps
        const a = {type:'stamp', kind:tool, x:p.x, y:p.y, sz:1};
        if(tool==='playerA' || tool==='playerB'){
          a.num = state.nextNumber;
          state.nextNumber += 1; $("#nextNumber").value = state.nextNumber;
        }
        D.actions.push(a);
        D.selection = [D.actions.length-1];
      }
      renderCanvas(i);
    }

    function move(e){
      const tool = state.tool;
      const D = state.drawings[i];
      const p = pos(e);

      if(tool==='select' && marquee){
        mRect = normRect(mStart, p);
        drawSelBox(selBox, mRect);
        return;
      }

      if(tool==='select' && draggingSelection && D.selection.length){
        const dx = p.x - dragStart.x;
        const dy = p.y - dragStart.y;
        dragStart = p;
        D.selection.forEach(idx=>{
          const a = D.actions[idx];
          if(a && a.type==='stamp'){ a.x += dx; a.y += dy; }
        });
        renderCanvas(i);
        // bin hover feedback
        if(isOverBin(e)){ $("#trashBin").classList.add('active'); } else { $("#trashBin").classList.remove('active'); }
        return;
      }

      if(!drawing) return;
      if(cur.type==='path'){ cur.pts.push(p); }
      else if(cur.type==='arrow'){ cur.x2=p.x; cur.y2=p.y; }
      renderCanvas(i);
    }

    function up(e){
      const tool = state.tool;
      const D = state.drawings[i];

      if(tool==='select' && marquee){
        marquee=false; selBox.hidden=true;
        const r = mRect;
        D.selection = [];
        D.actions.forEach((a,idx)=>{
          if(a.type!=='stamp') return;
          if(a.x>=r.x && a.x<=r.x+r.w && a.y>=r.y && a.y<=r.y+r.h){ D.selection.push(idx); }
        });
        renderCanvas(i);
        return;
      }

      if(tool==='select' && draggingSelection){
        if(isOverBin(e) && D.selection.length){
          D.selection.sort((a,b)=>b-a).forEach(idx=>D.actions.splice(idx,1));
          D.selection=[];
          $("#trashBin").classList.remove('active');
          renderCanvas(i);
        }
      }

      drawing=false; cur=null; draggingSelection=false;
    }

    layer.addEventListener("mousedown", down);
    layer.addEventListener("mousemove", move);
    window.addEventListener("mouseup", up);
    layer.addEventListener("touchstart", down, {passive:false});
    layer.addEventListener("touchmove", move, {passive:false});
    layer.addEventListener("touchend", up);
    // improve touch on canvas
    layer.style.touchAction = 'none';
  }

  function normRect(a,b){
    const x = Math.min(a.x,b.x), y=Math.min(a.y,b.y);
    return {x, y, w: Math.abs(b.x-a.x), h: Math.abs(b.y-a.y)};
  }
  function drawSelBox(el, r){
    el.hidden=false; el.style.left=r.x+'px'; el.style.top=r.y+'px'; el.style.width=r.w+'px'; el.style.height=r.h+'px';
  }
  function isOverBin(e){
    const binEl = $("#trashBin"); const rect = binEl.getBoundingClientRect();
    const x = (e.touches?e.touches[0].clientX:e.clientX), y = (e.touches?e.touches[0].clientY:e.clientY);
    return x>=rect.left && x<=rect.right && y>=rect.top && y<=rect.bottom;
  }

  function scaleSelection(f){
    const D = state.drawings[state.active];
    if(!D.selection.length) return;
    let cx=0, cy=0, n=0;
    D.selection.forEach(idx=>{ const a=D.actions[idx]; if(a && a.type==='stamp'){ cx+=a.x; cy+=a.y; n++; } });
    if(!n) return; cx/=n; cy/=n;
    D.selection.forEach(idx=>{
      const a=D.actions[idx]; if(a && a.type==='stamp'){
        a.x = cx + (a.x-cx)*f; a.y = cy + (a.y-cy)*f; a.sz = Math.max(0.4, Math.min(3, (a.sz||1)*f));
      }
    });
    renderCanvas(state.active);
  }
  function deleteSelection(){
    const D = state.drawings[state.active];
    if(!D.selection.length) return;
    D.selection.sort((a,b)=>b-a).forEach(idx=>D.actions.splice(idx,1));
    D.selection=[]; renderCanvas(state.active);
  }

  function renderCanvas(i){
    const pitch = $(`.pitch[data-i="${i}"]`);
    if(!pitch) return;
    const layer = pitch.querySelector(".draw-layer");
    const grid  = pitch.querySelector(".grid-layer");
    const ctx = layer.getContext("2d");
    const gtx = grid.getContext("2d");
    const D = state.drawings[i];

    // grid
    gtx.clearRect(0,0,grid.width,grid.height);
    if(D.grid){
      gtx.strokeStyle='#d0e8d4'; gtx.lineWidth=1;
      const step = Math.max(16, Math.min(grid.width,grid.height)/20);
      for(let x=0;x<=grid.width;x+=step){ gtx.beginPath(); gtx.moveTo(x,0); gtx.lineTo(x,grid.height); gtx.stroke(); }
      for(let y=0;y<=grid.height;y+=step){ gtx.beginPath(); gtx.moveTo(0,y); gtx.lineTo(grid.width,y); gtx.stroke(); }
    }

    // draw actions
    ctx.clearRect(0,0,layer.width,layer.height);
    D.actions.forEach((a,idx)=>{
      if(a.type==='path'){
        ctx.strokeStyle=a.color; ctx.lineWidth=a.w; ctx.lineCap='round'; ctx.lineJoin='round';
        ctx.beginPath(); a.pts.forEach((p,j)=> j?ctx.lineTo(p.x,p.y):ctx.moveTo(p.x,p.y)); ctx.stroke();
      } else if(a.type==='arrow'){
        ctx.strokeStyle=a.color; ctx.lineWidth=a.w;
        ctx.beginPath(); ctx.moveTo(a.x1,a.y1); ctx.lineTo(a.x2,a.y2); ctx.stroke();
        const ang=Math.atan2(a.y2-a.y1,a.x2-a.x1), head=12;
        ctx.beginPath();
        ctx.moveTo(a.x2,a.y2);
        ctx.lineTo(a.x2-head*Math.cos(ang-Math.PI/6), a.y2-head*Math.sin(ang-Math.PI/6));
        ctx.moveTo(a.x2,a.y2);
        ctx.lineTo(a.x2-head*Math.cos(ang+Math.PI/6), a.y2-head*Math.sin(ang+Math.PI/6));
        ctx.stroke();
      } else if(a.type==='stamp'){
        const s = a.sz||1;
        if(a.kind==='playerA'||a.kind==='playerB'){
          ctx.fillStyle='#222';
          ctx.beginPath(); ctx.arc(a.x,a.y,10*s,0,Math.PI*2); ctx.fill();
          if(state.showNumbers && (a.num!=null)){
            ctx.fillStyle='#fff'; ctx.font = `${10*s}px system-ui, sans-serif`; ctx.textAlign='center'; ctx.textBaseline='middle';
            ctx.fillText(String(a.num), a.x, a.y);
          }
        } else if(a.kind==='cone'){
          ctx.fillStyle='#222'; ctx.beginPath();
          ctx.moveTo(a.x, a.y-10*s); ctx.lineTo(a.x-9*s, a.y+8*s); ctx.lineTo(a.x+9*s, a.y+8*s); ctx.closePath(); ctx.fill();
        } else if(a.kind==='ball'){
          ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(a.x,a.y,9*s,0,Math.PI*2); ctx.fill();
          ctx.strokeStyle='#222'; ctx.lineWidth=1.75*s; ctx.beginPath(); ctx.arc(a.x,a.y,9*s,0,Math.PI*2); ctx.stroke();
          ctx.strokeStyle='#222'; ctx.lineWidth=1.25*s; ctx.globalAlpha=0.45;
          ctx.beginPath(); ctx.moveTo(a.x, a.y-9*s); ctx.lineTo(a.x, a.y+9*s); ctx.moveTo(a.x-9*s, a.y); ctx.lineTo(a.x+9*s, a.y); ctx.stroke();
          ctx.globalAlpha=1;
        }
        // selection ring
        if(D.selection.includes(idx)){
          ctx.strokeStyle='#111'; ctx.lineWidth=1; ctx.setLineDash([4,3]);
          ctx.beginPath(); ctx.arc(a.x,a.y, (a.kind==='cone'?12:12)*s, 0, Math.PI*2); ctx.stroke(); ctx.setLineDash([]);
        }
      }
    });
  }

  // ---- Print ----
  $("#btnPrint").addEventListener("click", ()=>window.print());

  // ---- Boot ----
  function renderAll(){
    renderOverview();
    renderDrills();
    state.drills.forEach((_,i)=>renderCanvas(i));
  }
  renderAll();

  // Helpers
  function esc(s){
    return String(s ?? "").replace(/[&<>]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[m]));
  }
})();
</script>
</body>
</html>
