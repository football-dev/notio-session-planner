<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Tacti.OS ‚Äî Session Planner</title>
<style>
  :root{--ink:#111;--muted:#666;--line:#d9d9d9;--box:#f7f7f7;--green:#E0F3E4}
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:#fff;color:var(--ink);font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}

  /* Top bar */
  .toolbar{position:sticky;top:0;z-index:30;display:flex;gap:10px;align-items:center;padding:10px 14px;border-bottom:1px solid var(--line);background:#fff}
  .toolbar h1{font-size:16px;margin:0}
  .sp{flex:1}
  button{appearance:none;background:#fff;border:1px solid var(--line);padding:7px 10px;border-radius:10px;cursor:pointer}
  button.primary{background:#111;color:#fff;border-color:#111}
  button.small{padding:6px 8px;border-radius:8px;font-size:12px}
  button.active{outline:2px solid #111}

  /* Layout: left sidebar (vertical toolbar) + content */
  .wrap{display:grid;grid-template-columns:220px 1fr;gap:0;max-width:1200px;margin:0 auto}
  @media(max-width:900px){ .wrap{grid-template-columns:1fr} }

  /* Sidebar */
  .side{position:sticky;top:52px;align-self:start;height:calc(100vh - 52px);overflow:auto;border-right:1px solid var(--line);padding:12px;background:#fff;z-index:20}
  .sec{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
  .chip{padding:4px 8px;border:1px solid var(--line);background:var(--box);border-radius:8px;font-size:12px;font-weight:600;color:#555;cursor:default;user-select:none}
  .toolrow{display:flex;flex-wrap:wrap;gap:6px}
  .icon{display:inline-block;width:14px;height:14px;border-radius:50%;vertical-align:-2px;margin-right:4px}
  .icon.blue{background:#3b82f6}.icon.red{background:#ef4444}.icon.orange{background:#f59e0b}
  .icon.ball{background:radial-gradient(circle at 50% 50%, #fff 40%, #111 41%)}
  .bin{margin-top:8px;border:1px dashed #bbb;border-radius:10px;padding:10px;text-align:center;color:#555}
  .bin.active{border-color:#111;background:#fafafa}
  .side .status{font-size:12px;color:#555;margin-top:6px}

  /* Content area */
  .page{padding:16px;display:grid;gap:14px}
  .card{border:1px solid var(--line);border-radius:16px;padding:12px}
  .title{font-weight:600;color:#444;margin:0 0 8px 0;font-size:18px}
  .mini-lab{font-weight:600;color:#555;font-size:14px;margin:8px 0 4px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .row-30-70{grid-template-columns:30% 70%}
  input[type=text]{width:100%;border:1px solid var(--line);border-radius:8px;padding:8px 10px;background:#fff}
  textarea{width:100%;border:1px solid var(--line);border-radius:10px;padding:10px;background:#fff;min-height:96px}

  /* Summary */
  .summary{border:1px solid var(--line);border-radius:10px;overflow:hidden;background:var(--box)}
  .summary .hdr, .summary .r{display:grid;grid-template-columns:20% 20% 60%}
  .summary .hdr{font-size:12px;font-weight:600;color:#666;border-bottom:1px solid var(--line)}
  .summary .hdr>div, .summary .r>div{padding:6px 8px;border-left:1px solid var(--line)}
  .summary .hdr>div:first-child, .summary .r>div:first-child{border-left:0}

  /* Drills */
  .drill{border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:5mm}
  .drill .hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
  .two-col{display:grid;grid-template-columns:62% 38%;gap:16px} /* wider editor column */

  /* Pitch + drawing */
  .pitch{position:relative;background:var(--green);border:1px solid #aaa;border-radius:12px;aspect-ratio:13/10;width:100%;overflow:hidden;outline-offset:3px}
  .pitch svg{width:100%;height:100%;display:block}
  .draw-layer,.grid-layer{position:absolute;inset:0}
  .grid-layer{pointer-events:none}
  .active-pitch{outline:3px solid #111}
  .selbox{position:absolute;border:1px dashed #111;background:rgba(17,17,17,.04);pointer-events:none}

  .notes{border:1px solid var(--line);border-radius:10px;height:120px}
  .footer{color:#999;font-size:11px;text-align:right;margin-top:6px}

  @media print{
    .toolbar,.side{display:none}
    .wrap{display:block}
    .page{padding:0}
    input,textarea{border:none !important}
    @page{size:A4 portrait;margin:10mm}
  }
</style>
</head>
<body>
  <!-- Top -->
  <div class="toolbar">
    <h1>Tacti.OS ‚Äî Session Planner</h1>
    <div class="sp"></div>
    <button id="btnPrint" class="primary">Print / Export PDF</button>
  </div>

  <div class="wrap">
    <!-- LEFT: Vertical toolbar -->
    <aside class="side" id="sidebar">
      <div class="sec">
        <div class="chip">Tools</div>
        <div class="toolrow">
          <button class="small" data-tool="select" id="tSelect">Select</button>
          <button class="small" data-tool="pen"    id="tPen">Pen</button>
          <button class="small" data-tool="eraser" id="tEraser">Eraser</button>
          <button class="small" data-tool="arrow"  id="tArrow">Arrow</button>
        </div>
      </div>

      <div class="sec">
        <div class="chip">Stamps</div>
        <div class="toolrow">
          <button class="small" data-tool="playerA"><span class="icon blue"></span>A</button>
          <button class="small" data-tool="playerB"><span class="icon red"></span>B</button>
          <button class="small" data-tool="cone"><span class="icon orange"></span>Cone</button>
          <button class="small" data-tool="ball"><span class="icon ball"></span>Ball</button>
        </div>
      </div>

      <div class="sec">
        <div class="chip">Numbers</div>
        <div class="toolrow" style="gap:8px">
          <label class="small" style="display:flex;align-items:center;gap:6px;color:#555"><input type="checkbox" id="toggleNumbers"> Show #</label>
          <label class="small" style="display:flex;align-items:center;gap:6px;color:#555">Next # <input type="number" id="nextNumber" value="1" min="0" style="width:68px"></label>
          <label class="small" style="display:flex;align-items:center;gap:6px;color:#555">Set # <input type="number" id="setNumber" value="0" min="0" style="width:68px"> <button class="small" id="applyNumber">Apply</button></label>
        </div>
      </div>

      <div class="sec">
        <div class="chip">Actions</div>
        <div class="toolrow">
          <button class="small" data-act="undo">Undo</button>
          <button class="small" data-act="redo">Redo</button>
          <button class="small" data-act="clear">Clear</button>
          <button class="small" data-act="grid">Grid</button>
          <button class="small" data-act="sizePlus">Size +</button>
          <button class="small" data-act="sizeMinus">Size ‚àí</button>
          <button class="small" data-act="deleteSelected">Delete Selected</button>
        </div>
        <div class="bin" id="trashBin">üóëÔ∏è Drag here to delete</div>
        <div class="status" id="activeChip">Editing: Drill 1</div>
      </div>

      <div class="sec">
        <div class="chip">Drills</div>
        <div class="toolrow">
          <button class="small" id="btnAddDrill">+ Add Drill</button>
          <button class="small" id="btnRemoveDrill">Remove Last</button>
        </div>
      </div>
    </aside>

    <!-- RIGHT: Content -->
    <main class="page" id="app">
      <!-- Header -->
      <div class="card">
        <div class="title">Session Header</div>
        <div class="row">
          <label><span class="mini-lab">Session Title</span><input type="text" id="title"></label>
          <label><span class="mini-lab">Age Group</span><input type="text" id="ageGroup"></label>
        </div>
        <div class="row row-30-70" style="margin-top:8px">
          <label><span class="mini-lab">Players</span><input type="text" id="players"></label>
          <label><span class="mini-lab">Objective</span><input type="text" id="objective"></label>
          <label><span class="mini-lab">Area needed</span><input type="text" id="area"></label>
          <label><span class="mini-lab">Equipment</span><input type="text" id="equipment"></label>
        </div>
      </div>

      <!-- Overview -->
      <div class="card">
        <div class="title">Drill Overview (editable)</div>
        <div class="summary" id="overview">
          <div class="hdr"><div>Drill</div><div>Duration</div><div>Purpose / Notes</div></div>
          <!-- rows injected -->
        </div>
      </div>

      <!-- Drills -->
      <div id="drills"></div>

      <!-- Notes -->
      <div class="card">
        <div class="title">Coach Notes / Reflection</div>
        <div class="notes"></div>
        <div class="footer">Template by Alex Hammond-Cole | Tacti.OS</div>
      </div>
    </main>
  </div>

<script>
(function(){
  const $ = (s,root=document)=>root.querySelector(s);
  const $$ = (s,root=document)=>Array.from(root.querySelectorAll(s));

  // ---- Data ----
  const defaultDrills = [
    { name:"Passing Practice",   duration:"~10 min",    purpose:"Warm up & intro of session focus", setup:"", exercise:"", progression:"" },
    { name:"Positioning Game",   duration:"~10‚Äì15 min", purpose:"Posession Game",                    setup:"", exercise:"", progression:"" },
    { name:"Game Training",      duration:"~20‚Äì25 min", purpose:"Realistic match situation",         setup:"", exercise:"", progression:"" },
    { name:"Training Game",      duration:"~20‚Äì25 min", purpose:"Game",                               setup:"", exercise:"", progression:"" }
  ];

  const state = {
    title:"", ageGroup:"", players:"", objective:"", area:"", equipment:"",
    drills: JSON.parse(JSON.stringify(defaultDrills)),
    drawings: [],      // per-drill {actions:[], redo:[], grid:false, selection:number[]}
    active: 0,         // active drill index for drawing
    tool: 'select',
    showNumbers: false,
    nextNumber: 1
  };
  state.drawings = state.drills.map(()=>({actions:[],redo:[],grid:false, selection:[]}));

  // ---- UI: header + overview ----
  ["title","ageGroup","players","objective","area","equipment"].forEach(id=>{
    $("#"+id).addEventListener("input", e=>{ state[id]=e.target.value; });
  });

  const overview = $("#overview");
  function renderOverview(){
    $$(".r", overview).forEach(n=>n.remove());
    state.drills.forEach((d,i)=>{
      const row = document.createElement("div");
      row.className = "r";
      row.innerHTML = `
        <div><input type="text" value="${esc(d.name)}" data-i="${i}" data-k="name" style="width:100%"></div>
        <div><input type="text" value="${esc(d.duration)}" data-i="${i}" data-k="duration" style="width:100%"></div>
        <div><input type="text" value="${esc(d.purpose)}" data-i="${i}" data-k="purpose" style="width:100%"></div>
      `;
      overview.appendChild(row);
    });
    $$("input", overview).forEach(inp=>{
      inp.addEventListener("input", e=>{
        const i=+e.target.dataset.i, k=e.target.dataset.k;
        state.drills[i][k]=e.target.value;
        const hdr = $(`.drill[data-i="${i}"] .name`);
        if(hdr && k==="name") hdr.textContent = e.target.value || `Drill ${i+1}`;
      });
    });
  }

  // ---- Sidebar (global toolbar) ----
  const sidebar = $("#sidebar"), bin = $("#trashBin");
  function setActiveTool(tool){
    state.tool = tool;
    $$("button[data-tool]", sidebar).forEach(b=>b.classList.toggle("active", b.dataset.tool===tool));
  }
  setActiveTool('select');

  $("#toggleNumbers").addEventListener("change", e=>{
    state.showNumbers = e.target.checked;
    state.drills.forEach((_,i)=>renderCanvas(i));
  });
  $("#nextNumber").addEventListener("input", e=>{ state.nextNumber = +e.target.value || 0; });
  $("#applyNumber").addEventListener("click", ()=>{
    const n = +$("#setNumber").value || 0;
    const D = state.drawings[state.active];
    D.selection.forEach(idx=>{
      const a = D.actions[idx];
      if(a && a.type==='stamp' && (a.kind==='playerA' || a.kind==='playerB')) a.num = n;
    });
    renderCanvas(state.active);
  });

  sidebar.addEventListener("click", e=>{
    const btn = e.target.closest("button");
    if(!btn) return;
    const tool = btn.dataset.tool;
    const act  = btn.dataset.act;
    if(tool){ setActiveTool(tool); return; }

    const D = state.drawings[state.active];
    if(act==="undo"){
      if(D.actions.length){ D.redo.push(D.actions.pop()); D.selection=[]; renderCanvas(state.active); }
    } else if(act==="redo"){
      if(D.redo.length){ D.actions.push(D.redo.pop()); D.selection=[]; renderCanvas(state.active); }
    } else if(act==="clear"){
      D.actions = []; D.redo = []; D.selection=[]; renderCanvas(state.active);
    } else if(act==="grid"){
      D.grid = !D.grid; renderCanvas(state.active);
    } else if(act==="sizePlus"){
      scaleSelection(1.15);
    } else if(act==="sizeMinus"){
      scaleSelection(1/1.15);
    } else if(act==="deleteSelected"){
      deleteSelection();
    }
  });

  // drill add/remove (global)
  $("#btnAddDrill").addEventListener("click", ()=>{
    state.drills.push({name:"New Drill", duration:"", purpose:"", setup:"", exercise:"", progression:""});
    state.drawings.push({actions:[], redo:[], grid:false, selection:[]});
    state.active = state.drills.length - 1;
    renderAll();
    scrollToDrill(state.active);
  });

  $("#btnRemoveDrill").addEventListener("click", ()=>{
    if(!state.drills.length) return;
    const idx = state.active;
    state.drills.splice(idx,1);
    state.drawings.splice(idx,1);
    state.active = Math.max(0, idx-1);
    renderAll();
  });

  // ---- Drills list ----
  const drillsRoot = $("#drills");
  function renderDrills(){
    drillsRoot.innerHTML = "";
    state.drills.forEach((d,i)=>{
      const card = document.createElement("div");
      card.className = "card drill";
      card.dataset.i = i;
      card.innerHTML = `
        <div class="hdr">
          <div class="name">${esc(d.name) || `Drill ${i+1}`}</div>
          <button class="small" title="Delete drill" data-act="trash" data-i="${i}">üóëÔ∏è</button>
        </div>
        <div class="two-col">
          <div>
            <div class="mini-lab">Setup</div>
            <textarea data-i="${i}" data-k="setup">${esc(d.setup)}</textarea>
            <div class="mini-lab">Exercise</div>
            <textarea data-i="${i}" data-k="exercise">${esc(d.exercise)}</textarea>
            <div class="mini-lab">Progression</div>
            <textarea data-i="${i}" data-k="progression">${esc(d.progression)}</textarea>
          </div>
          <div>
            <div class="pitch" data-i="${i}" tabindex="0">
              <svg viewBox="0 0 1000 650">
                <rect x="10" y="10" width="980" height="630" fill="none" stroke="#AAAAAA" stroke-width="3"/>
                <line x1="20" y1="40" x2="980" y2="40" stroke="#BBBBBB" stroke-width="2"/>
                <rect x="160" y="300" width="680" height="260" fill="none" stroke="#AAAAAA" stroke-width="2"/>
                <rect x="260" y="410" width="480" height="150" fill="none" stroke="#AAAAAA" stroke-width="2"/>
                <circle cx="500" cy="360" r="6" fill="#AAAAAA"/>
              </svg>
              <canvas class="draw-layer"></canvas>
              <canvas class="grid-layer"></canvas>
              <div class="selbox" hidden></div>
            </div>
          </div>
        </div>
      `;
      drillsRoot.appendChild(card);

      // per-drill trash
      card.querySelector('[data-act="trash"]').addEventListener("click", ()=>{
        const idx = i;
        state.drills.splice(idx,1);
        state.drawings.splice(idx,1);
        state.active = Math.max(0, Math.min(state.active, state.drills.length-1));
        renderAll();
      });

      // text bindings
      $$("textarea", card).forEach(t=>{
        t.addEventListener("input", e=>{
          const i2=+e.target.dataset.i, k=e.target.dataset.k;
          state.drills[i2][k]=e.target.value;
        });
      });

      // canvas setup
      const pitch = card.querySelector(".pitch");
      setupCanvas(pitch, i);
      if(i===state.active) pitch.classList.add("active-pitch");
      pitch.addEventListener("click", ()=>setActivePitch(i));
    });
    updateActiveChip();
  }

  function setActivePitch(i){
    state.active = i;
    $$(".pitch").forEach(p=>p.classList.remove("active-pitch"));
    const pitch = $(`.pitch[data-i="${i}"]`);
    if(pitch) pitch.classList.add("active-pitch");
    updateActiveChip();
  }
  function updateActiveChip(){
    $("#activeChip").textContent = `Editing: Drill ${state.active+1}`;
  }

  function scrollToDrill(i){
    const el = $(`.drill[data-i="${i}"]`);
    if(el) el.scrollIntoView({behavior:'smooth', block:'center'});
  }

  // ---- Canvas drawing engine (with marquee + drag-to-bin) ----
  function setupCanvas(pitch, i){
    const layer = pitch.querySelector(".draw-layer");
    const gridL = pitch.querySelector(".grid-layer");
    const selBox = pitch.querySelector(".selbox");
    function resize(){
      const r = pitch.getBoundingClientRect();
      [layer, gridL].forEach(c=>{ c.width=r.width; c.height=r.height; });
      renderCanvas(i);
    }
    new ResizeObserver(resize).observe(pitch);
    resize();

    let drawing=false, cur=null;
    let draggingSelection=false, dragStart=null;
    let marquee=false, mStart=null, mRect=null; // marquee selection

    function pos(e){
      const r=layer.getBoundingClientRect();
      const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left;
      const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top;
      return {x,y};
    }

    function hitStampAt(x,y, D){
      for(let k=D.actions.length-1;k>=0;k--){
        const a = D.actions[k];
        if(a.type==='stamp'){
          const rad = (a.sz||1)*10 + 4;
          const dx = x-a.x, dy=y-a.y;
          if(dx*dx+dy*dy <= rad*rad) return k;
        }
      }
      return -1;
    }

    function down(e){
      e.preventDefault();
      setActivePitch(i);
      const tool = state.tool;
      const D = state.drawings[i];
      const p = pos(e);

      if(tool==='select'){
        const hit = hitStampAt(p.x,p.y,D);
        if(hit>=0){
          if(e.shiftKey){
            const j = D.selection.indexOf(hit);
            if(j>=0) D.selection.splice(j,1);
            else D.selection.push(hit);
          } else {
            if(D.selection.length!==1 || D.selection[0]!==hit) D.selection = [hit];
          }
          draggingSelection = true; dragStart = p;
        } else {
          // start marquee
          D.selection = [];
          marquee = true; mStart = p; mRect = {x: p.x, y: p.y, w: 0, h: 0};
          drawSelBox(selBox, mRect, false);
        }
        renderCanvas(i, selBox);
        return;
      }

      D.redo = [];
      if(tool==='pen'){
        drawing=true; cur={type:'path', color:'#111', w:3, pts:[p]}; D.actions.push(cur);
      } else if(tool==='eraser'){
        drawing=true; cur={type:'path', color:'#fff', w:16, pts:[p]}; D.actions.push(cur);
      } else if(tool==='arrow'){
        drawing=true; cur={type:'arrow', color:'#111', w:3, x1:p.x, y1:p.y, x2:p.x, y2:p.y}; D.actions.push(cur);
      } else { // stamps
        const a = {type:'stamp', kind:tool, x:p.x, y:p.y, sz:1};
        if(tool==='playerA' || tool==='playerB'){
          a.num = state.nextNumber;
          state.nextNumber += 1; $("#nextNumber").value = state.nextNumber;
        }
        D.actions.push(a);
        D.selection = [D.actions.length-1];
      }
      renderCanvas(i, selBox);
    }

    function move(e){
      const tool = state.tool;
      const D = state.drawings[i];
      const p = pos(e);

      // marquee
      if(tool==='select' && marquee){
        mRect = normRect(mStart, p);
        drawSelBox(selBox, mRect, false);
        return;
      }

      // dragging selection
      if(tool==='select' && draggingSelection && D.selection.length){
        const dx = p.x - dragStart.x;
        const dy = p.y - dragStart.y;
        dragStart = p;
        D.selection.forEach(idx=>{
          const a = D.actions[idx];
          if(a && a.type==='stamp'){ a.x += dx; a.y += dy; }
        });
        renderCanvas(i, selBox);
        // bin hover feedback
        if(isOverBin(e)){ bin.classList.add('active'); } else { bin.classList.remove('active'); }
        return;
      }

      if(!drawing) return;
      if(cur.type==='path'){ cur.pts.push(p); }
      else if(cur.type==='arrow'){ cur.x2=p.x; cur.y2=p.y; }
      renderCanvas(i, selBox);
    }

    function up(e){
      const tool = state.tool;
      const D = state.drawings[i];

      // finish marquee
      if(tool==='select' && marquee){
        marquee=false; selBox.hidden=true;
        const r = mRect;
        D.selection = [];
        D.actions.forEach((a,idx)=>{
          if(a.type!=='stamp') return;
          if(a.x>=r.x && a.x<=r.x+r.w && a.y>=r.y && a.y<=r.y+r.h){ D.selection.push(idx); }
        });
        renderCanvas(i);
        return;
      }

      // finish drag-to-bin
      if(tool==='select' && draggingSelection){
        if(isOverBin(e) && D.selection.length){
          D.selection.sort((a,b)=>b-a).forEach(idx=>D.actions.splice(idx,1));
          D.selection=[];
          bin.classList.remove('active');
          renderCanvas(i);
        }
      }

      drawing=false; cur=null; draggingSelection=false;
    }

    layer.addEventListener("mousedown", down);
    layer.addEventListener("mousemove", move);
    window.addEventListener("mouseup", up);
    layer.addEventListener("touchstart", down, {passive:false});
    layer.addEventListener("touchmove", move, {passive:false});
    layer.addEventListener("touchend", up);
  }

  function normRect(a,b){
    const x = Math.min(a.x,b.x), y=Math.min(a.y,b.y);
    return {x, y, w: Math.abs(b.x-a.x), h: Math.abs(b.y-a.y)};
  }
  function drawSelBox(el, r){
    el.hidden=false; el.style.left=r.x+'px'; el.style.top=r.y+'px'; el.style.width=r.w+'px'; el.style.height=r.h+'px';
  }
  function isOverBin(e){
    const binEl = $("#trashBin"); const rect = binEl.getBoundingClientRect();
    const x = (e.touches?e.touches[0].clientX:e.clientX), y = (e.touches?e.touches[0].clientY:e.clientY);
    return x>=rect.left && x<=rect.right && y>=rect.top && y<=rect.bottom;
  }

  function scaleSelection(f){
    const D = state.drawings[state.active];
    if(!D.selection.length) return;
    let cx=0, cy=0, n=0;
    D.selection.forEach(idx=>{ const a=D.actions[idx]; if(a && a.type==='stamp'){ cx+=a.x; cy+=a.y; n++; } });
    if(!n) return; cx/=n; cy/=n;
    D.selection.forEach(idx=>{
      const a=D.actions[idx]; if(a && a.type==='stamp'){
        a.x = cx + (a.x-cx)*f; a.y = cy + (a.y-cy)*f; a.sz = Math.max(0.4, Math.min(3, (a.sz||1)*f));
      }
    });
    renderCanvas(state.active);
  }
  function deleteSelection(){
    const D = state.drawings[state.active];
    if(!D.selection.length) return;
    D.selection.sort((a,b)=>b-a).forEach(idx=>D.actions.splice(idx,1));
    D.selection=[]; renderCanvas(state.active);
  }

  function renderCanvas(i){
    const pitch = $(`.pitch[data-i="${i}"]`);
    if(!pitch) return;
    const layer = pitch.querySelector(".draw-layer");
    const grid  = pitch.querySelector(".grid-layer");
    const selBox= pitch.querySelector(".selbox");
    const ctx = layer.getContext("2d");
    const gtx = grid.getContext("2d");
    const D = state.drawings[i];

    // grid
    gtx.clearRect(0,0,grid.width,grid.height);
    if(D.grid){
      gtx.strokeStyle='#d0e8d4'; gtx.lineWidth=1;
      const step = Math.max(16, Math.min(grid.width,grid.height)/20);
      for(let x=0;x<=grid.width;x+=step){ gtx.beginPath(); gtx.moveTo(x,0); gtx.lineTo(x,grid.height); gtx.stroke(); }
      for(let y=0;y<=grid.height;y+=step){ gtx.beginPath(); gtx.moveTo(0,y); gtx.lineTo(grid.width,y); gtx.stroke(); }
    }

    // draw
    ctx.clearRect(0,0,layer.width,layer.height);
    D.actions.forEach((a,idx)=>{
      if(a.type==='path'){
        ctx.strokeStyle=a.color; ctx.lineWidth=a.w; ctx.lineCap='round'; ctx.lineJoin='round';
        ctx.beginPath(); a.pts.forEach((p,j)=> j?ctx.lineTo(p.x,p.y):ctx.moveTo(p.x,p.y)); ctx.stroke();
      } else if(a.type==='arrow'){
        ctx.strokeStyle=a.color; ctx.lineWidth=a.w;
        ctx.beginPath(); ctx.moveTo(a.x1,a.y1); ctx.lineTo(a.x2,a.y2); ctx.stroke();
        const ang=Math.atan2(a.y2-a.y1,a.x2-a.x1), head=12;
        ctx.beginPath();
        ctx.moveTo(a.x2,a.y2);
        ctx.lineTo(a.x2-head*Math.cos(ang-Math.PI/6), a.y2-head*Math.sin(ang-MI_PI/6));
      } else if(a.type==='arrow'){
        /* ensure arrowheads */
        ctx.strokeStyle=a.color; ctx.lineWidth=a.w;
        ctx.beginPath(); ctx.moveTo(a.x1,a.y1); ctx.lineTo(a.x2,a.y2); ctx.stroke();
        const ang=Math.atan2(a.y2-a.y1,a.x2-a.x1), head=12;
        ctx.beginPath();
        ctx.moveTo(a.x2,a.y2);
        ctx.lineTo(a.x2-head*Math.cos(ang-Math.PI/6), a.y2-head*Math.sin(ang-Math.PI/6));
        ctx.moveTo(a.x2,a.y2);
        ctx.lineTo(a.x2-head*Math.cos(ang+Math.PI/6), a.y2-head*Math.sin(ang+Math.PI/6));
        ctx.stroke();
      } else if(a.type==='stamp'){
        const s = a.sz||1;
        if(a.kind==='playerA'||a.kind==='playerB'){
          ctx.fillStyle=a.kind==='playerA'?'#3b82f6':'#ef4444';
          ctx.beginPath(); ctx.arc(a.x,a.y,10*s,0,Math.PI*2); ctx.fill();
          if(state.showNumbers && (a.num!=null)){
            ctx.fillStyle='#fff'; ctx.font = `${10*s}px system-ui, sans-serif`; ctx.textAlign='center'; ctx.textBaseline='middle';
            ctx.fillText(String(a.num), a.x, a.y);
          }
        } else if(a.kind==='cone'){
          ctx.fillStyle='#f59e0b'; ctx.beginPath();
          ctx.moveTo(a.x, a.y-10*s); ctx.lineTo(a.x-9*s, a.y+8*s); ctx.lineTo(a.x+9*s, a.y+8*s); ctx.closePath(); ctx.fill();
        } else if(a.kind==='ball'){
          ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(a.x,a.y,9*s,0,Math.PI*2); ctx.fill();
          ctx.strokeStyle='#111'; ctx.lineWidth=2*s; ctx.beginPath(); ctx.arc(a.x,a.y,9*s,0,Math.PI*2); ctx.stroke();
        }
        if(D.selection.includes(idx)){
          ctx.strokeStyle='#111'; ctx.lineWidth=1; ctx.setLineDash([4,3]);
          ctx.beginPath(); ctx.arc(a.x,a.y, (a.kind==='cone'?12:12)*s, 0, Math.PI*2); ctx.stroke(); ctx.setLineDash([]);
        }
      }
    });
    if(selBox) selBox.hidden = true;
  }

  // ---- Print / Export ----
  $("#btnPrint").addEventListener("click", ()=>window.print());

  // ---- Boot ----
  function renderAll(){
    renderOverview();
    renderDrills();
    state.drills.forEach((_,i)=>renderCanvas(i));
  }
  renderAll();

  // Helpers
  function esc(s){ return String(s??"").replace(/[&<>]/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m])); }
})();
</script>
</body>
</html>
